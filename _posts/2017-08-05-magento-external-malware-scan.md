---
layout: blog-single
title: Magento External Malware Scans
description: A look an why and how to run an external malware scan against a Magento installation
date: August 05, 2017
image:  /img/blog/external-malware-scan/radioactive-symbol-on-brick-background.jpg
tags: [Magento, Security]
ad: domain-clamp-ad-b.html
---

[magento-malware-scanner](https://github.com/gwillem/magento-malware-scanner) is an extremely valuable tool to help keep your Magento installation secure. Scanning a codebase for malware is dead simple...

```
wget git.io/mwscan.txt
grep -Erlf mwscan.txt /path/to/magento
```

However, it's equally if not more important to run an external scan of your Magento installation. Here I'll cover why and how.

<!-- excerpt_separator -->

### Why Do I Need To Run An External Scan?

The reason you need to run an external scan is because simply scanning your codebase misses cases where the malware is injected into the database. This class of attack is extremely common because the attacker can install malware simply by accessing the admin panel and [updating "miscellaneous html"]({{ site.baseurl }}{% link _posts/2016-11-12-the-dangers-of-miscellaneous-html.md %}) or a CMS block and does not need access to the file system on the server.

### How Do I Do It?

Fortunately, it's not particularly difficult to run an external scan. You can use `wget` to download the contents of a page and then send the returned HTML to magento-malware-scanner.

```
wget -O result https://www.example.com && grep -Elf mwscan.txt result
```

### What If The Malware Is Not Inlined?

`wget -O` will catch cases where the malware is inlined into the HTML document, however if will miss if the malware is referenced via a `<script>` tag. To solve this we can use [the `-p` flag](https://www.gnu.org/software/wget/manual/html_node/Recursive-Retrieval-Options.html) to download the "page requisites". This will scripts referenced via a `<script>` tag.

```
wget -p https://www.example.com && grep -Erlf mwscan.txt www.example.com
```

### What If The Malware Is Hosted Elsewhere?

Good point, the `-p` flag by default will only download the assets from the same host. We need to combine it with [the `-H` flag](https://www.gnu.org/software/wget/manual/html_node/Spanning-Hosts.html) (span hosts) to download from other hosts

It's easiest to additionally use [the `-P` flag](https://www.gnu.org/software/wget/manual/html_node/Directory-Options.html) (directory prefix) to put everything into a single folder

```
wget -p -H -P scan https://www.example.com && grep -Erlf mwscan.txt scan
```

At this point we will be scanning both all inlined and `<script>` referenced Javascripts.

### Leveling Up Your External Scans

Scanning https://www.example.com is great, but what if the malware is in a static block that is only inserted into the page on the checkout page? In that case, we won't catch it. 

To help deal with this problem, I built [Mpchadwick_MwscanUtils](https://github.com/mpchadwick/Mpchadwick_MwscanUtils). Currently the tool allows the following...

1. Send a request to https://www.example.com/mwscanutils/contentdump. This endpoint will simply ALL the content from EVERY CMS page and block as well as the contents of the miscellaneous scripts and miscellaneous HTML fields.
2. The ability to fetch the html for the checkout page via wget. Typically the request would be redirected due to the session not containing any quote items, however if you pass the mwscanutils_force param the page will still be loaded (https://www.example.com/checkout/onepage/index/mwscanutils_force/1).

The module was built for Magento 1 as the lion share of live Magento installations are still running Magento 1, but it wouldn't be difficult to port over to Magento 2.

The tools is 100% free and open source and is [available on GitHub](https://github.com/mpchadwick/Mpchadwick_MwscanUtils).

### Some Final Pro Tips

A couple final pro-tips with external scans...

1. Regularly run both an internal and external scan against your Magento installation. Ideally you should be [doing this on a cron](https://github.com/gwillem/magento-malware-scanner/blob/master/docs/usage.md#running-from-cron). You can also use `wget`'s `-q` flag to prevent it from making any noise. 
2. Run your external scans on dedicated server that is not the server that is hosting the Magento installation. If the attacker gains access to the Magento system they could simply disable the cronjob preventing you from ever getting any alerts.

Happy scanning!

